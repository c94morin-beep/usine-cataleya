<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Production Multi-Listes - Sousou Fashion</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getDatabase, ref, get, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
        const firebaseConfig = {
            apiKey: "AIzaSyDVpN0cbCqDYI2klKrWqZJAcYDX2ayx8F0",
            authDomain: "usine-cataleya.firebaseapp.com",
            databaseURL: "https://usine-cataleya-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "usine-cataleya",
            storageBucket: "usine-cataleya.firebasestorage.app",
            messagingSenderId: "218489156781",
            appId: "1:218489156781:web:92f657e50e63222a130224"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        window.firebaseSignIn = (email, password) => signInWithEmailAndPassword(auth, email, password);
        window.firebaseSignOut = () => signOut(auth);
        window.firebaseOnAuthStateChanged = (cb) => onAuthStateChanged(auth, cb);
        window.firebaseGetUserRole = async (uid) => {
            const snapshot = await get(ref(db, 'users/' + uid + '/role'));
            return snapshot.exists() ? snapshot.val() : null;
        };
        window.firebaseSaveLists = async (lists) => {
            await set(ref(db, 'lists'), lists);
        };
        window.firebaseOnLists = (cb) => {
            return onValue(ref(db, 'lists'), (snapshot) => {
                cb(snapshot.exists() ? snapshot.val() : []);
            });
        };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Statuts
        const STATUTS = {
            EN_ATTENTE: 'En attente',
            TERMINE: 'Termin√©',
            AVEC_COMMENTAIRE: 'Avec commentaire'
        };

        // Composant principal
        function App() {
            const [lists, setLists] = useState([]);
            const [activeListId, setActiveListId] = useState('global');
            const [activeTab, setActiveTab] = useState('dashboard');
            const [searchTerm, setSearchTerm] = useState('');
            const [filterStatus, setFilterStatus] = useState('all');
            const [showImportModal, setShowImportModal] = useState(false);
            const [completionAlert, setCompletionAlert] = useState(null); // {reference, client, autresCommandes[]}

            // Auth
            const [user, setUser] = useState(null);
            const [userRole, setUserRole] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);

            useEffect(() => {
                const init = () => {
                    window.firebaseOnAuthStateChanged(async (firebaseUser) => {
                        if (firebaseUser) {
                            const role = await window.firebaseGetUserRole(firebaseUser.uid);
                            setUser(firebaseUser); setUserRole(role);
                        } else { setUser(null); setUserRole(null); }
                        setAuthLoading(false);
                    });
                };
                if (window.firebaseOnAuthStateChanged) { init(); }
                else { window.addEventListener('firebase-ready', init); return () => window.removeEventListener('firebase-ready', init); }
            }, []);

            // Charger les donn√©es depuis Firebase en temps r√©el
            useEffect(() => {
                if (!user) return;
                const init = () => {
                    const unsub = window.firebaseOnLists((data) => {
                        setLists(Array.isArray(data) ? data : Object.values(data || {}));
                    });
                    return unsub;
                };
                if (window.firebaseOnLists) {
                    const unsub = init();
                    return () => unsub && unsub();
                } else {
                    window.addEventListener('firebase-ready', () => { init(); }, { once: true });
                }
            }, [user]);

            // Sauvegarder sur Firebase
            const saveLists = (newLists) => {
                setLists(newLists);
                const doSave = () => {
                    if (window.firebaseSaveLists) {
                        console.log('Sauvegarde Firebase...', newLists.length, 'listes');
                        window.firebaseSaveLists(newLists)
                            .then(() => console.log('Firebase OK'))
                            .catch(e => console.error('Firebase ERREUR:', e));
                    } else {
                        console.warn('firebaseSaveLists pas encore dispo, retry...');
                        setTimeout(doSave, 500);
                    }
                };
                doSave();
            };

            // Obtenir toutes les commandes (pour la vue globale)
            const getAllOrders = () => {
                return lists.flatMap(list => list.orders);
            };

            // Obtenir les commandes de la liste active
            const getActiveOrders = () => {
                if (activeListId === 'global') {
                    return getAllOrders();
                }
                const activeList = lists.find(l => l.id === activeListId);
                return activeList ? activeList.orders : [];
            };

            // Calculer les stats
            const calculateStats = (orders) => {
                return {
                    total: orders.length,
                    enAttente: orders.filter(o => o.status === STATUTS.EN_ATTENTE).length,
                    termines: orders.filter(o => o.status === STATUTS.TERMINE).length,
                    avecCommentaire: [...new Set(orders.filter(o => o.commentaires && o.commentaires.trim() !== '').map(o => o.reference))].length
                };
            };

            // Import nouvelle liste
            const handleImportNewList = (listName, file) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const text = event.target.result;
                        const lines = text.split('\n');
                        
                        if (lines.length < 2) {
                            alert('Fichier CSV vide ou invalide');
                            return;
                        }
                        
                        // Parser le CSV manuellement (format avec point-virgule)
                        const headers = lines[0].split(';').map(h => h.trim());
                        console.log('En-t√™tes CSV:', headers); // Debug
                        const data = [];
                        
                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;
                            
                            const values = lines[i].split(';');
                            console.log('Ligne', i, ':', values); // Debug
                            
                            if (values.length >= 9) {
                                const row = {
                                    reference: values[0]?.replace(/"/g, '').trim() || '',
                                    name: values[1]?.replace(/"/g, '').trim() || '',
                                    url_image: values[2]?.replace(/"/g, '').trim() || '',
                                    total: values[3]?.replace(/"/g, '').trim() || '1',
                                    client: values[4]?.replace(/"/g, '').trim() || '',
                                    adresse_livraison: values[5]?.replace(/"/g, '').trim() || '',
                                    telephone: values[6]?.replace(/"/g, '').trim() || '',
                                    email: values[7]?.replace(/"/g, '').trim() || '',
                                    transporteur: values[8]?.replace(/"/g, '').trim() || ''
                                };
                                data.push(row);
                            }
                        }

                        const transformedData = data.map((row, index) => ({
                            id: `${Date.now()}-${index}`,
                            reference: row.reference,
                            name: row.name,
                            url_image: row.url_image,
                            commentaires: '',
                            quantity: parseInt(row.total) || 1,
                            status: STATUTS.EN_ATTENTE,
                            client: row.client,
                            adresse_livraison: row.adresse_livraison,
                            telephone: row.telephone,
                            email: row.email,
                            transporteur: row.transporteur
                        }));

                        const newList = {
                            id: `list-${Date.now()}`,
                            name: listName,
                            createdAt: new Date().toISOString(),
                            orders: transformedData
                        };

                        const updatedLists = [...lists, newList];
                        saveLists(updatedLists);
                        setActiveListId(newList.id);
                        setShowImportModal(false);
                        alert(`‚úÖ ${transformedData.length} articles import√©s dans "${listName}" !`);
                    } catch (error) {
                        console.error('Erreur import:', error);
                        alert('‚ùå Erreur lors de l\'importation : ' + error.message);
                    }
                };
                reader.readAsText(file, 'UTF-8');
            };

            // Supprimer une liste
            const deleteList = (listId) => {
                if (confirm('Voulez-vous vraiment supprimer cette liste ?')) {
                    const updatedLists = lists.filter(l => l.id !== listId);
                    saveLists(updatedLists);
                    if (activeListId === listId) {
                        setActiveListId('global');
                    }
                }
            };

            // Mettre √† jour un statut
            const updateStatus = (orderId, newStatus, newCommentaires) => {
                const updatedLists = lists.map(list => ({
                    ...list,
                    orders: list.orders.map(order =>
                        order.id === orderId 
                            ? { ...order, status: newStatus, commentaires: newCommentaires !== undefined ? newCommentaires : order.commentaires } 
                            : order
                    )
                }));
                saveLists(updatedLists);

                // Afficher la popup √† chaque fois qu'un article est termin√©
                if (newStatus === STATUTS.TERMINE) {
                    const allOrders = updatedLists.flatMap(l => l.orders);
                    const thisOrder = allOrders.find(o => o.id === orderId);
                    if (thisOrder) {
                        const ref = thisOrder.reference;
                        const client = thisOrder.client;
                        const email = thisOrder.email;
                        const articlesCommande = allOrders.filter(o => o.reference === ref);
                        const total = articlesCommande.length;
                        const termines = articlesCommande.filter(o => o.status === STATUTS.TERMINE).length;
                        const tousTermines = termines === total;
                        const autresCommandes = [...new Set(
                            allOrders
                                .filter(o => 
                                    o.reference !== ref &&
                                    o.status !== STATUTS.TERMINE &&
                                    (o.client === client || (email && o.email === email))
                                )
                                .map(o => o.reference)
                        )];

                        // V√©rifier si toutes les commandes de cette cliente sont termin√©es
                        let toutesCommandesTerminees = false;
                        let toutesCommandes = [];
                        if (tousTermines && autresCommandes.length === 0) {
                            // R√©cup√©rer toutes les commandes de cette cliente (termin√©es)
                            const tousRefs = [...new Set(
                                allOrders
                                    .filter(o => o.client === client || (email && o.email === email))
                                    .map(o => o.reference)
                            )];
                            if (tousRefs.length >= 2) {
                                // V√©rifier que toutes sont bien termin√©es
                                const toutesOk = tousRefs.every(r =>
                                    allOrders.filter(o => o.reference === r).every(o => o.status === STATUTS.TERMINE)
                                );
                                if (toutesOk) {
                                    toutesCommandesTerminees = true;
                                    toutesCommandes = tousRefs.sort((a,b) => b - a).map(r => ({
                                        reference: r,
                                        nbArticles: allOrders.filter(o => o.reference === r).length
                                    }));
                                }
                            }
                        }

                        setCompletionAlert({ reference: ref, client, autresCommandes, termines, total, tousTermines, toutesCommandesTerminees, toutesCommandes });
                    }
                }
            };

            // Mettre √† jour un commentaire
            const updateComment = (orderId, newComment) => {
                const updatedLists = lists.map(list => ({
                    ...list,
                    orders: list.orders.map(order =>
                        order.id === orderId ? { ...order, commentaires: newComment } : order
                    )
                }));
                saveLists(updatedLists);
            };

            const activeOrders = getActiveOrders();
            const stats = calculateStats(activeOrders);

            // Filtrer les commandes
            const filteredOrders = activeOrders.filter(order => {
                const matchSearch = order.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                  order.reference.toString().includes(searchTerm);
                const matchStatus = filterStatus === 'all' || order.status === filterStatus;
                return matchSearch && matchStatus;
            });

            if (authLoading) return (
                <div className="min-h-screen flex items-center justify-center">
                    <p className="text-gray-500 text-lg">Chargement...</p>
                </div>
            );
            if (!user) return <LoginPage />;
            const isAdmin = userRole === 'admin';

            return (
                <div className="min-h-screen">
                    {/* Popup Commande Compl√®te */}
                    {completionAlert && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] p-4" onClick={() => setCompletionAlert(null)}>
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6" onClick={e => e.stopPropagation()}>
                                <div className="text-center mb-4">
                                    {completionAlert.tousTermines ? (
                                        <>
                                            <div className="text-5xl mb-3">üéâ</div>
                                            <h3 className="text-xl font-bold text-green-700">Commande #{completionAlert.reference} compl√®te !</h3>
                                            <p className="text-gray-500 text-sm mt-1">Tous les articles sont pr√™ts pour l'envoi.</p>
                                        </>
                                    ) : (
                                        <>
                                            <div className="text-5xl mb-3">‚úÖ</div>
                                            <h3 className="text-xl font-bold text-blue-700">Article termin√© ‚Äî Commande #{completionAlert.reference}</h3>
                                            <p className="text-gray-500 text-sm mt-1">
                                                <span className="font-bold text-green-600">{completionAlert.termines}</span> / {completionAlert.total} articles termin√©s ‚Äî il en reste <span className="font-bold text-orange-500">{completionAlert.total - completionAlert.termines}</span>
                                            </p>
                                            <div className="w-full bg-gray-100 rounded-full h-3 mt-3">
                                                <div className="bg-orange-400 h-3 rounded-full transition-all" style={{width: `${Math.round((completionAlert.termines / completionAlert.total) * 100)}%`}}></div>
                                            </div>
                                            <p className="text-xs text-gray-400 mt-1">{Math.round((completionAlert.termines / completionAlert.total) * 100)}%</p>
                                        </>
                                    )}
                                </div>
                                {completionAlert.toutesCommandesTerminees ? (
                                    <div className="bg-green-50 border-2 border-green-400 rounded-xl p-4 mt-2">
                                        <p className="text-green-800 font-bold text-sm mb-3">üöÄ Toutes les commandes de {completionAlert.client} sont pr√™tes !</p>
                                        <div className="space-y-2">
                                            {completionAlert.toutesCommandes.map(c => (
                                                <div key={c.reference} className="flex items-center justify-between bg-white border border-green-200 rounded-lg px-3 py-2">
                                                    <span className="font-mono font-bold text-green-800">#{c.reference}</span>
                                                    <span className="text-xs text-gray-500">{c.nbArticles} article(s)</span>
                                                    <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">‚úÖ Pr√™t</span>
                                                </div>
                                            ))}
                                        </div>
                                        <p className="text-green-700 font-semibold text-sm mt-3 text-center">üì¶ Vous pouvez tout envoyer ensemble !</p>
                                    </div>
                                ) : completionAlert.autresCommandes.length > 0 ? (
                                    <div className="bg-orange-50 border border-orange-200 rounded-xl p-4 mt-4">
                                        <p className="text-orange-700 font-semibold text-sm">
                                            ‚ö†Ô∏è {completionAlert.client} a aussi {completionAlert.autresCommandes.length} autre(s) commande(s) en cours :
                                        </p>
                                        <div className="flex flex-wrap gap-2 mt-2">
                                            {completionAlert.autresCommandes.map(ref => (
                                                <span key={ref} className="font-mono text-sm bg-orange-100 text-orange-800 px-3 py-1 rounded-full font-semibold">#{ref}</span>
                                            ))}
                                        </div>
                                        <p className="text-orange-600 text-xs mt-2">üí° Pensez √† regrouper l'envoi !</p>
                                    </div>
                                ) : null}
                                <button
                                    onClick={() => setCompletionAlert(null)}
                                    className="mt-5 w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-xl transition"
                                >
                                    OK, compris !
                                </button>
                            </div>
                        </div>
                    )}
                    {/* Header */}
                    <header className="bg-gradient-to-r from-green-600 to-emerald-600 text-white shadow-lg">
                        <div className="container mx-auto px-6 py-4 flex justify-between items-center">
                            <div>
                                <h1 className="text-xl md:text-3xl font-bold">üì¶ Gestion Production</h1>
                                <p className="text-green-100 text-xs md:text-sm hidden sm:block">Sousou Fashion - Suivi multi-listes</p>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className="text-right">
                                    <p className="text-xs md:text-sm font-semibold truncate max-w-32 md:max-w-none">{user.email}</p>
                                    <span className={`text-xs px-2 py-0.5 rounded-full font-semibold ${isAdmin ? 'bg-yellow-300 text-yellow-900' : 'bg-white bg-opacity-30 text-white'}`}>
                                        {isAdmin ? 'üîë Admin' : 'üëÅ Lecture'}
                                    </span>
                                </div>
                                <button onClick={() => window.firebaseSignOut()} className="px-2 md:px-3 py-1 md:py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg text-xs md:text-sm font-semibold transition">
                                    D√©connexion
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Navigation Listes */}
                    <nav className="bg-white border-b border-gray-200 sticky top-0 z-10 shadow-sm">
                        <div className="container mx-auto px-6">
                            <div className="flex items-center gap-2 overflow-x-auto py-2">
                                {/* Onglet Global */}
                                <button
                                    onClick={() => setActiveListId('global')}
                                    className={`px-4 py-2 rounded-lg font-semibold whitespace-nowrap transition ${
                                        activeListId === 'global'
                                            ? 'bg-blue-100 text-blue-700 border-2 border-blue-300'
                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                    }`}
                                >
                                    üìÇ GLOBAL ({getAllOrders().length})
                                </button>

                                {/* Onglets des listes */}
                                {lists.map(list => (
                                    <div key={list.id} className="flex items-center gap-1">
                                        <button
                                            onClick={() => setActiveListId(list.id)}
                                            className={`px-4 py-2 rounded-lg font-semibold whitespace-nowrap transition ${
                                                activeListId === list.id
                                                    ? 'bg-green-100 text-green-700 border-2 border-green-300'
                                                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                            }`}
                                        >
                                            üìã {list.name} ({list.orders.length})
                                        </button>
                                        {isAdmin && <button onClick={() => deleteList(list.id)} className="px-2 py-2 text-red-600 hover:bg-red-50 rounded" title="Supprimer cette liste">‚úï</button>}
                                    </div>
                                ))}

                                {isAdmin && <button onClick={() => setShowImportModal(true)} className="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition whitespace-nowrap">‚ûï Nouvelle liste</button>}
                            </div>
                        </div>
                    </nav>

                    {/* Modal Import */}
                    {showImportModal && (
                        <ImportModal
                            onImport={handleImportNewList}
                            onClose={() => setShowImportModal(false)}
                        />
                    )}

                    {/* Tabs */}
                    <nav className="bg-white border-b border-gray-200">
                        <div className="container mx-auto px-6">
                            <div className="flex gap-1">
                                <TabButton
                                    active={activeTab === 'dashboard'}
                                    onClick={() => setActiveTab('dashboard')}
                                    icon="üìä"
                                    label="Dashboard"
                                />
                                <TabButton
                                    active={activeTab === 'production'}
                                    onClick={() => setActiveTab('production')}
                                    icon="‚úÇÔ∏è"
                                    label="Suivi Production"
                                />
                                <TabButton
                                    active={activeTab === 'orders'}
                                    onClick={() => setActiveTab('orders')}
                                    icon="üîç"
                                    label="Par Commande"
                                />
                                <TabButton
                                    active={activeTab === 'multiorders'}
                                    onClick={() => setActiveTab('multiorders')}
                                    icon="üëØ"
                                    label="Multi-Commandes"
                                />
                            </div>
                        </div>
                    </nav>

                    {/* Contenu */}
                    <main className="container mx-auto px-3 md:px-6 py-4 md:py-8">
                        {lists.length === 0 && activeListId === 'global' ? (
                            <EmptyState onImport={() => setShowImportModal(true)} />
                        ) : (
                            <>
                                {activeTab === 'dashboard' && (
                                    <Dashboard stats={stats} orders={activeOrders} listName={activeListId === 'global' ? 'GLOBAL' : lists.find(l => l.id === activeListId)?.name} />
                                )}
                                {activeTab === 'production' && (
                                    <ProductionTab
                                        orders={filteredOrders}
                                        searchTerm={searchTerm}
                                        setSearchTerm={setSearchTerm}
                                        filterStatus={filterStatus}
                                        setFilterStatus={setFilterStatus}
                                        updateStatus={updateStatus}
                                        updateComment={updateComment}
                                        isAdmin={isAdmin}
                                    />
                                )}
                                {activeTab === 'orders' && (
                                    <OrdersTab orders={activeOrders} updateStatus={updateStatus} isAdmin={isAdmin} />
                                )}
                                {activeTab === 'multiorders' && (
                                    <MultiOrdersTab orders={activeOrders} />
                                )}
                            </>
                        )}
                    </main>
                </div>
            );
        }

        // Composant TabButton
        function TabButton({ active, onClick, icon, label }) {
            return (
                <button
                    onClick={onClick}
                    className={`px-6 py-3 font-semibold transition border-b-4 ${
                        active
                            ? 'text-green-600 border-green-600 bg-green-50'
                            : 'text-gray-600 border-transparent hover:text-green-600 hover:bg-gray-50'
                    }`}
                >
                    {icon} {label}
                </button>
            );
        }

        // Modal Import
        function ImportModal({ onImport, onClose }) {
            const [listName, setListName] = useState('');
            const [file, setFile] = useState(null);

            const handleSubmit = () => {
                if (!listName.trim()) {
                    alert('Veuillez donner un nom √† la liste');
                    return;
                }
                if (!file) {
                    alert('Veuillez s√©lectionner un fichier');
                    return;
                }
                onImport(listName, file);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <h3 className="text-xl font-bold mb-4">‚ûï Importer une nouvelle liste</h3>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-semibold mb-2">Nom de la liste</label>
                                <input
                                    type="text"
                                    placeholder="Ex: F√©vrier Semaine 1"
                                    value={listName}
                                    onChange={(e) => setListName(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-semibold mb-2">Fichier CSV</label>
                                <input
                                    type="file"
                                    accept=".csv"
                                    onChange={(e) => setFile(e.target.files[0])}
                                    className="w-full"
                                />
                                <p className="text-xs text-gray-500 mt-1">Format attendu : CSV avec point-virgule (export PrestaShop)</p>
                            </div>
                        </div>

                        <div className="flex gap-3 mt-6">
                            <button
                                onClick={handleSubmit}
                                className="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700"
                            >
                                Importer
                            </button>
                            <button
                                onClick={onClose}
                                className="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300"
                            >
                                Annuler
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Empty State
        function EmptyState({ onImport }) {
            return (
                <div className="text-center py-16">
                    <div className="text-6xl mb-4">üì¶</div>
                    <h2 className="text-2xl font-bold text-gray-800 mb-2">Aucune liste import√©e</h2>
                    <p className="text-gray-600 mb-6">Commencez par importer votre premi√®re liste de commandes</p>
                    <button
                        onClick={onImport}
                        className="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700"
                    >
                        ‚ûï Importer ma premi√®re liste
                    </button>
                </div>
            );
        }

        // Dashboard
        function Dashboard({ stats, orders, listName }) {
            const [showTerminesModal, setShowTerminesModal] = useState(false);
            const [showCommentairesModal, setShowCommentairesModal] = useState(false);
            const [selectedOrder, setSelectedOrder] = useState(null);
            const terminesOrders = orders.filter(o => o.status === STATUTS.TERMINE);
            const terminesRefs = [...new Set(terminesOrders.map(o => o.reference))].sort((a, b) => b - a);

            const openOrderRecap = (reference) => {
                const orderItems = orders.filter(o => o.reference === reference);
                if (orderItems.length > 0) {
                    setSelectedOrder({
                        reference: reference,
                        client: orderItems[0].client,
                        adresse_livraison: orderItems[0].adresse_livraison,
                        telephone: orderItems[0].telephone,
                        email: orderItems[0].email,
                        transporteur: orderItems[0].transporteur,
                        items: orderItems
                    });
                }
            };

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold">Dashboard - {listName}</h2>
                    
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <StatCard title="Total Articles" value={stats.total} color="blue" icon="üì¶" />
                        <StatCard title="En attente" value={stats.enAttente} color="yellow" icon="‚è≥" />
                        <StatCard title="Termin√©s" value={stats.termines} color="green" icon="‚úÖ" onClick={() => setShowTerminesModal(true)} clickable={true} />
                        <StatCard title="Avec commentaire" value={stats.avecCommentaire} color="purple" icon="üí¨" onClick={() => setShowCommentairesModal(true)} clickable={true} />
                    </div>

                    <div className="bg-white rounded-lg shadow p-6">
                        <h3 className="text-lg font-semibold mb-3">Avancement global</h3>
                        <div className="w-full bg-gray-200 rounded-full h-6">
                            <div
                                className="bg-gradient-to-r from-green-500 to-emerald-500 h-6 rounded-full flex items-center justify-center text-white text-sm font-semibold transition-all"
                                style={{ width: `${stats.total > 0 ? Math.round((stats.termines / stats.total) * 100) : 0}%` }}
                            >
                                {stats.total > 0 ? Math.round((stats.termines / stats.total) * 100) : 0}%
                            </div>
                        </div>
                    </div>

                    {showTerminesModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col">
                                <div className="flex justify-between items-center p-6 border-b">
                                    <h3 className="text-xl font-bold text-green-700">‚úÖ Commandes termin√©es ({terminesRefs.length})</h3>
                                    <button onClick={() => setShowTerminesModal(false)} className="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
                                </div>
                                <div className="overflow-y-auto p-6">
                                    {terminesRefs.length === 0 ? (
                                        <p className="text-gray-500 text-center py-8">Aucune commande termin√©e pour l'instant</p>
                                    ) : (
                                        <div className="space-y-6">
                                            {(() => {
                                                const byTransporteur = {};
                                                terminesOrders.forEach(o => {
                                                    const t = o.transporteur || 'Non d√©fini';
                                                    if (!byTransporteur[t]) byTransporteur[t] = new Set();
                                                    byTransporteur[t].add(o.reference);
                                                });
                                                return Object.entries(byTransporteur).sort((a,b) => a[0].localeCompare(b[0])).map(([transporteur, refs]) => {
                                                    const refsArray = [...refs].sort((a,b) => b - a);
                                                    return (
                                                        <div key={transporteur}>
                                                            <div className="flex items-center justify-between mb-2">
                                                                <h4 className="font-bold text-gray-700">üöö {transporteur}</h4>
                                                                <span className="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full">{refsArray.length} commande(s)</span>
                                                            </div>
                                                            <div className="border border-gray-200 rounded-lg overflow-hidden">
                                                                {refsArray.map((ref, index) => (
                                                                    <div key={ref} className={`py-2 px-3 ${index % 2 === 0 ? 'bg-green-50' : 'bg-white'}`}>
                                                                        <button
                                                                            onClick={(e) => { e.stopPropagation(); openOrderRecap(ref); }}
                                                                            className="font-mono text-green-900 text-base hover:text-blue-600 hover:underline cursor-pointer text-left w-full flex items-center gap-2"
                                                                        >
                                                                            {ref}
                                                                        </button>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    );
                                                });
                                            })()}
                                        </div>
                                    )}
                                </div>
                                <div className="p-4 border-t bg-gray-50 rounded-b-xl">
                                    <p className="text-sm text-gray-500 text-center">{terminesOrders.length} article(s) termin√©(s) au total</p>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal Avec Commentaires */}
                    {showCommentairesModal && (() => {
                        const commandesAvecCommentaire = {};
                        orders.forEach(o => {
                            if (o.commentaires && o.commentaires.trim()) {
                                if (!commandesAvecCommentaire[o.reference]) commandesAvecCommentaire[o.reference] = [];
                                commandesAvecCommentaire[o.reference].push(o);
                            }
                        });
                        const refs = Object.keys(commandesAvecCommentaire).sort((a,b) => b - a);
                        return (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col">
                                    <div className="flex justify-between items-center p-6 border-b">
                                        <h3 className="text-xl font-bold text-purple-700">üí¨ Commandes avec commentaire ({refs.length})</h3>
                                        <button onClick={() => setShowCommentairesModal(false)} className="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
                                    </div>
                                    <div className="overflow-y-auto p-6">
                                        {refs.length === 0 ? (
                                            <p className="text-gray-500 text-center py-8">Aucun commentaire pour l'instant</p>
                                        ) : (
                                            <div className="space-y-3">
                                                {refs.map(ref => (
                                                    <div key={ref} className="border border-purple-100 rounded-lg overflow-hidden">
                                                        <div className="bg-purple-50 px-4 py-2 flex items-center justify-between">
                                                            <button
                                                                onClick={() => { setShowCommentairesModal(false); openOrderRecap(ref); }}
                                                                className="font-mono font-bold text-purple-800 hover:text-blue-600 hover:underline"
                                                            >
                                                                #{ref}
                                                            </button>
                                                            <span className="text-xs text-purple-500">{commandesAvecCommentaire[ref][0].client}</span>
                                                        </div>
                                                        {commandesAvecCommentaire[ref].map((o, i) => (
                                                            <div key={i} className="px-4 py-2 border-t border-purple-50">
                                                                <p className="text-sm text-gray-700 truncate">{o.name}</p>
                                                                <p className="text-sm italic text-purple-600 mt-0.5">üí¨ {o.commentaires}</p>
                                                            </div>
                                                        ))}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                    <div className="p-4 border-t bg-gray-50 rounded-b-xl">
                                        <p className="text-sm text-gray-500 text-center">{refs.length} commande(s) avec commentaire</p>
                                    </div>
                                </div>
                            </div>
                        );
                    })()}

                    {/* Modal R√©capitulatif Commande */}
                    {selectedOrder && (
                        <div 
                            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4"
                            onClick={() => setSelectedOrder(null)}
                        >
                            <div 
                                className="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto"
                                onClick={(e) => e.stopPropagation()}
                            >
                                <div className="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-t-lg">
                                    <div className="flex justify-between items-start">
                                        <div className="flex-1">
                                            <h3 className="text-2xl font-bold mb-3">üì¶ Commande #{selectedOrder.reference}</h3>
                                            <div className="space-y-2 text-blue-100">
                                                {selectedOrder.client && (
                                                    <p className="flex items-start gap-2"><span className="text-lg">üë§</span><span className="font-semibold">{selectedOrder.client}</span></p>
                                                )}
                                                {selectedOrder.adresse_livraison && (
                                                    <p className="flex items-start gap-2"><span className="text-lg">üìç</span><span>{selectedOrder.adresse_livraison}</span></p>
                                                )}
                                                {selectedOrder.telephone && (
                                                    <p className="flex items-start gap-2"><span className="text-lg">üìû</span><a href={`tel:${selectedOrder.telephone}`} className="hover:underline">{selectedOrder.telephone}</a></p>
                                                )}
                                                {selectedOrder.email && (
                                                    <p className="flex items-start gap-2"><span className="text-lg">‚úâÔ∏è</span><a href={`mailto:${selectedOrder.email}`} className="hover:underline">{selectedOrder.email}</a></p>
                                                )}
                                                {selectedOrder.transporteur && (
                                                    <p className="flex items-start gap-2"><span className="text-lg">üöö</span><span>{selectedOrder.transporteur}</span></p>
                                                )}
                                            </div>
                                        </div>
                                        <button onClick={() => setSelectedOrder(null)} className="text-white hover:text-gray-200 text-2xl font-bold">‚úï</button>
                                    </div>
                                </div>
                                <div className="p-6">
                                    <h4 className="font-semibold text-gray-700 mb-4 text-lg">Articles ({selectedOrder.items.length})</h4>
                                    <div className="space-y-3">
                                        {selectedOrder.items.map((item) => (
                                            <div key={item.id} className="flex items-start gap-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                                {item.url_image && (
                                                    <img src={item.url_image} alt={item.name} className="w-20 h-20 object-cover rounded border" onError={(e) => e.target.style.display = 'none'} />
                                                )}
                                                <div className="flex-1">
                                                    <h5 className="font-semibold text-gray-900">{item.name}</h5>
                                                    <div className="mt-2 flex flex-wrap items-center gap-2">
                                                        <span className="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold">Qt√©: {item.quantity || 1}</span>
                                                        <span className={`px-3 py-1 rounded-full text-sm font-semibold ${item.status === 'Termin√©' ? 'bg-green-100 text-green-700' : item.status === 'En attente' ? 'bg-yellow-100 text-yellow-700' : 'bg-purple-100 text-purple-700'}`}>{item.status}</span>
                                                    </div>
                                                    {item.commentaires && (
                                                        <p className="mt-2 text-sm text-gray-600 bg-white p-2 rounded border border-gray-200">üí¨ {item.commentaires}</p>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-6 pt-4 border-t border-gray-200 flex justify-between items-center">
                                        <span className="font-semibold text-gray-700">Total articles:</span>
                                        <span className="text-2xl font-bold text-blue-600">{selectedOrder.items.length}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // StatCard
        function StatCard({ title, value, color, icon, onClick, clickable }) {
            const colors = {
                blue: 'bg-blue-50 border-blue-200 text-blue-700',
                yellow: 'bg-yellow-50 border-yellow-200 text-yellow-700',
                green: 'bg-green-50 border-green-200 text-green-700',
                purple: 'bg-purple-50 border-purple-200 text-purple-700'
            };
            return (
                <div className={`rounded-lg border-2 p-6 ${colors[color]} ${clickable ? 'cursor-pointer hover:shadow-md hover:scale-105 transition-transform' : ''}`}
                    onClick={clickable ? onClick : undefined}>
                    <div className="flex justify-between items-start">
                        <div>
                            <p className="text-sm font-medium opacity-75">{title}</p>
                            <p className="text-3xl font-bold mt-1">{value}</p>
                            {clickable && <p className="text-xs opacity-60 mt-1">Cliquer pour voir ‚Ä∫</p>}
                        </div>
                        <div className="text-4xl opacity-50">{icon}</div>
                    </div>
                </div>
            );
        }

        // ProductionTab
        function ProductionTab({ orders, searchTerm, setSearchTerm, filterStatus, setFilterStatus, updateStatus, isAdmin }) {
            const [selectedImage, setSelectedImage] = React.useState(null);
            const [selectedOrder, setSelectedOrder] = React.useState(null); // Pour le r√©cap commande
            const [sortColumn, setSortColumn] = React.useState('reference'); // Colonne de tri par d√©faut
            const [sortDirection, setSortDirection] = React.useState('asc'); // asc ou desc
            
            // Fonction de tri
            const handleSort = (column) => {
                if (sortColumn === column) {
                    // Inverse la direction si on clique sur la m√™me colonne
                    setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                } else {
                    // Nouvelle colonne, tri ascendant par d√©faut
                    setSortColumn(column);
                    setSortDirection('asc');
                }
            };
            
            // Trier les commandes
            const sortedOrders = [...orders].sort((a, b) => {
                let aVal = a[sortColumn] || '';
                let bVal = b[sortColumn] || '';
                
                // Tri num√©rique pour reference
                if (sortColumn === 'reference') {
                    aVal = parseInt(aVal) || 0;
                    bVal = parseInt(bVal) || 0;
                } else {
                    // Tri alphab√©tique pour les autres
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                }
                
                if (sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            // Fonction pour ouvrir le r√©cap d'une commande
            const openOrderRecap = (reference) => {
                // R√©cup√©rer tous les articles de cette commande
                const orderItems = orders.filter(o => o.reference === reference);
                if (orderItems.length > 0) {
                    setSelectedOrder({
                        reference: reference,
                        client: orderItems[0].client,
                        adresse_livraison: orderItems[0].adresse_livraison,
                        telephone: orderItems[0].telephone,
                        email: orderItems[0].email,
                        transporteur: orderItems[0].transporteur,
                        items: orderItems
                    });
                }
            };
            
            return (
                <div className="space-y-6">
                    {/* Modal Image en grand */}
                    {selectedImage && (
                        <div 
                            className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"
                            onClick={() => setSelectedImage(null)}
                        >
                            <div className="max-w-4xl max-h-[90vh] relative">
                                <button
                                    onClick={() => setSelectedImage(null)}
                                    className="absolute -top-10 right-0 text-white text-2xl hover:text-gray-300"
                                >
                                    ‚úï Fermer
                                </button>
                                <img 
                                    src={selectedImage.url}
                                    alt={selectedImage.name}
                                    className="max-w-full max-h-[90vh] object-contain rounded shadow-2xl"
                                    onClick={(e) => e.stopPropagation()}
                                />
                                <p className="text-white text-center mt-4 text-lg">{selectedImage.name}</p>
                            </div>
                        </div>
                    )}
                    
                    {/* Modal R√©capitulatif Commande */}
                    {selectedOrder && (
                        <div 
                            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                            onClick={() => setSelectedOrder(null)}
                        >
                            <div 
                                className="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto"
                                onClick={(e) => e.stopPropagation()}
                            >
                                {/* Header */}
                                <div className="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-t-lg">
                                    <div className="flex justify-between items-start">
                                        <div className="flex-1">
                                            <h3 className="text-2xl font-bold mb-3">üì¶ Commande #{selectedOrder.reference}</h3>
                                            
                                            {/* Infos client */}
                                            <div className="space-y-2 text-blue-100">
                                                {selectedOrder.client && (
                                                    <p className="flex items-start gap-2">
                                                        <span className="text-lg">üë§</span>
                                                        <span className="font-semibold">{selectedOrder.client}</span>
                                                    </p>
                                                )}
                                                {selectedOrder.adresse_livraison && (
                                                    <p className="flex items-start gap-2">
                                                        <span className="text-lg">üìç</span>
                                                        <span>{selectedOrder.adresse_livraison}</span>
                                                    </p>
                                                )}
                                                {selectedOrder.telephone && (
                                                    <p className="flex items-start gap-2">
                                                        <span className="text-lg">üìû</span>
                                                        <a href={`tel:${selectedOrder.telephone}`} className="hover:underline">
                                                            {selectedOrder.telephone}
                                                        </a>
                                                    </p>
                                                )}
                                                {selectedOrder.email && (
                                                    <p className="flex items-start gap-2">
                                                        <span className="text-lg">‚úâÔ∏è</span>
                                                        <a href={`mailto:${selectedOrder.email}`} className="hover:underline">
                                                            {selectedOrder.email}
                                                        </a>
                                                    </p>
                                                )}
                                                {selectedOrder.transporteur && (
                                                    <p className="flex items-start gap-2">
                                                        <span className="text-lg">üöö</span>
                                                        <span>{selectedOrder.transporteur}</span>
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                        <button
                                            onClick={() => setSelectedOrder(null)}
                                            className="text-white hover:text-gray-200 text-2xl font-bold"
                                        >
                                            ‚úï
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Corps */}
                                <div className="p-6">
                                    <h4 className="font-semibold text-gray-700 mb-4 text-lg">
                                        Articles ({selectedOrder.items.length})
                                    </h4>
                                    
                                    <div className="space-y-3">
                                        {selectedOrder.items.map((item) => (
                                            <div key={item.id} className="flex items-start gap-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                                {/* Photo */}
                                                {item.url_image && (
                                                    <img 
                                                        src={item.url_image} 
                                                        alt={item.name}
                                                        className="w-20 h-20 object-cover rounded border cursor-pointer hover:opacity-80"
                                                        onClick={() => setSelectedImage({ url: item.url_image, name: item.name })}
                                                        onError={(e) => e.target.style.display = 'none'}
                                                    />
                                                )}
                                                
                                                {/* Infos */}
                                                <div className="flex-1">
                                                    <h5 className="font-semibold text-gray-900">{item.name}</h5>
                                                    <div className="mt-2 flex flex-wrap items-center gap-2">
                                                        <span className="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold">
                                                            Qt√©: {item.quantity || 1}
                                                        </span>
                                                        <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                                                            item.status === 'Termin√©' ? 'bg-green-100 text-green-700' :
                                                            item.status === 'En attente' ? 'bg-yellow-100 text-yellow-700' :
                                                            'bg-purple-100 text-purple-700'
                                                        }`}>
                                                            {item.status}
                                                        </span>
                                                    </div>
                                                    {item.commentaires && (
                                                        <p className="mt-2 text-sm text-gray-600 bg-white p-2 rounded border border-gray-200">
                                                            üí¨ {item.commentaires}
                                                        </p>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    
                                    {/* Footer */}
                                    <div className="mt-6 pt-4 border-t border-gray-200 flex justify-between items-center">
                                        <span className="font-semibold text-gray-700">Total articles:</span>
                                        <span className="text-2xl font-bold text-blue-600">{selectedOrder.items.length}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    <div className="bg-white rounded-lg shadow p-6">
                        <div className="grid grid-cols-1 gap-3 md:grid-cols-3 md:gap-4">
                            <div>
                                <label className="block text-sm font-semibold mb-2">üîç Rechercher</label>
                                <input
                                    type="text"
                                    placeholder="Produit ou n¬∞ commande..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-semibold mb-2">üìä Statut</label>
                                <select
                                    value={filterStatus}
                                    onChange={(e) => setFilterStatus(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                >
                                    <option value="all">Tous</option>
                                    {Object.values(STATUTS).map(s => (
                                        <option key={s} value={s}>{s}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="flex items-end">
                                <button
                                    onClick={() => { setSearchTerm(''); setFilterStatus('all'); }}
                                    className="w-full px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
                                >
                                    üîÑ Effacer
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* TRI MOBILE */}
                    <div className="md:hidden bg-white rounded-lg shadow p-3 flex gap-2 items-center">
                        <span className="text-sm font-semibold text-gray-600 whitespace-nowrap">Trier par :</span>
                        <select
                            value={sortColumn}
                            onChange={(e) => setSortColumn(e.target.value)}
                            className="flex-1 px-2 py-1 border border-gray-300 rounded text-sm"
                        >
                            <option value="reference">N¬∞ Commande</option>
                            <option value="name">Produit</option>
                            <option value="client">Client</option>
                            <option value="transporteur">Transporteur</option>
                            <option value="status">Statut</option>
                        </select>
                        <button
                            onClick={() => setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc')}
                            className="px-3 py-1 bg-gray-100 rounded border text-sm font-semibold"
                        >
                            {sortDirection === 'asc' ? '‚Üë' : '‚Üì'}
                        </button>
                    </div>

                    {/* VUE MOBILE : cartes */}
                    <div className="md:hidden space-y-3">
                        {sortedOrders.map(order => (
                            <div key={order.id} className={`rounded-xl shadow p-4 border transition-colors ${
                                order.status === STATUTS.TERMINE ? 'bg-green-50 border-green-200' :
                                order.status === STATUTS.AVEC_COMMENTAIRE ? 'bg-orange-50 border-orange-200' :
                                'bg-white border-gray-200'
                            }`}>
                                <div className="flex gap-3">
                                    {order.url_image ? (
                                        <img src={order.url_image} alt={order.name}
                                            className="w-20 h-20 object-cover rounded-lg border flex-shrink-0 cursor-pointer"
                                            onClick={() => setSelectedImage({ url: order.url_image, name: order.name })}
                                            onError={(e) => e.target.style.display = 'none'} />
                                    ) : (
                                        <div className="w-20 h-20 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400 text-xs flex-shrink-0">Pas d'image</div>
                                    )}
                                    <div className="flex-1 min-w-0">
                                        <div className="flex justify-between items-start gap-2">
                                            <span className="font-bold text-blue-600 cursor-pointer text-sm" onClick={() => openOrderRecap(order.reference)}>#{order.reference}</span>
                                            <select
                                                value={order.status}
                                                onChange={(e) => isAdmin && updateStatus(order.id, e.target.value, order.commentaires)}
                                                disabled={!isAdmin}
                                                className={`text-xs px-2 py-1 border rounded flex-shrink-0 ${!isAdmin ? 'bg-gray-100 text-gray-400' : ''}`}
                                            >
                                                {Object.values(STATUTS).map(s => (<option key={s} value={s}>{s}</option>))}
                                            </select>
                                        </div>
                                        <p className="text-sm font-medium text-gray-800 mt-1 truncate">{order.name}</p>
                                        <p className="text-xs text-gray-500 mt-0.5">{order.client || ''}</p>
                                        <p className="text-xs text-gray-500">üöö {order.transporteur || '-'}</p>
                                    </div>
                                </div>
                                {order.commentaires ? (
                                    <div className="mt-3 flex items-center gap-2">
                                        <p className="flex-1 text-sm italic text-purple-700 bg-purple-50 border border-purple-200 rounded-lg px-3 py-2">üí¨ {order.commentaires}</p>
                                        {isAdmin && <button onClick={() => updateStatus(order.id, order.status, '')} className="text-xs text-red-400 hover:text-red-600">‚úï</button>}
                                    </div>
                                ) : isAdmin ? (
                                    <input
                                        type="text"
                                        defaultValue=""
                                        onBlur={(e) => e.target.value && updateStatus(order.id, order.status, e.target.value)}
                                        onKeyDown={(e) => e.key === 'Enter' && e.target.value && updateStatus(order.id, order.status, e.target.value)}
                                        placeholder="üí¨ Ajouter une note..."
                                        className="mt-3 w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500"
                                    />
                                ) : null}
                            </div>
                        ))}
                    </div>

                    {/* VUE DESKTOP : tableau */}
                    <div className="hidden md:block bg-white rounded-lg shadow overflow-x-auto">
                        <table className="w-full">
                            <thead className="bg-gray-50 border-b">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Photo</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase cursor-pointer hover:bg-gray-100" onClick={() => handleSort('reference')}>
                                        N¬∞ Commande {sortColumn === 'reference' && (sortDirection === 'asc' ? '‚Üë' : '‚Üì')}
                                    </th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase cursor-pointer hover:bg-gray-100" onClick={() => handleSort('name')}>
                                        Produit {sortColumn === 'name' && (sortDirection === 'asc' ? '‚Üë' : '‚Üì')}
                                    </th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase cursor-pointer hover:bg-gray-100" onClick={() => handleSort('client')}>
                                        Client {sortColumn === 'client' && (sortDirection === 'asc' ? '‚Üë' : '‚Üì')}
                                    </th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase cursor-pointer hover:bg-gray-100" onClick={() => handleSort('transporteur')}>
                                        Transporteur {sortColumn === 'transporteur' && (sortDirection === 'asc' ? '‚Üë' : '‚Üì')}
                                    </th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Commentaires</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase cursor-pointer hover:bg-gray-100" onClick={() => handleSort('status')}>
                                        Statut {sortColumn === 'status' && (sortDirection === 'asc' ? '‚Üë' : '‚Üì')}
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {sortedOrders.map(order => (
                                    <tr key={order.id} className={`border-b transition-colors ${
                                        order.status === STATUTS.TERMINE ? 'bg-green-50 hover:bg-green-100' :
                                        order.status === STATUTS.AVEC_COMMENTAIRE ? 'bg-orange-50 hover:bg-orange-100' :
                                        'bg-white hover:bg-gray-50'
                                    }`}>
                                        <td className="px-4 py-3">
                                            {order.url_image ? (
                                                <img src={order.url_image} alt={order.name}
                                                    className="w-16 h-16 object-cover rounded border cursor-pointer hover:opacity-80 transition"
                                                    onClick={() => setSelectedImage({ url: order.url_image, name: order.name })}
                                                    onError={(e) => e.target.style.display = 'none'} />
                                            ) : (
                                                <div className="w-16 h-16 bg-gray-100 rounded flex items-center justify-center text-gray-400 text-xs">Pas d'image</div>
                                            )}
                                        </td>
                                        <td className="px-4 py-3">
                                            <span className="font-semibold text-blue-600 cursor-pointer hover:text-blue-800 hover:underline" onClick={() => openOrderRecap(order.reference)}>#{order.reference}</span>
                                        </td>
                                        <td className="px-4 py-3">{order.name}</td>
                                        <td className="px-4 py-3 text-sm">{order.client || '-'}</td>
                                        <td className="px-4 py-3 text-sm">{order.transporteur || '-'}</td>
                                        <td className="px-4 py-3">
                                            {order.commentaires ? (
                                                <div className="flex items-center gap-1">
                                                    <p className="text-sm italic text-purple-700">üí¨ {order.commentaires}</p>
                                                    {isAdmin && <button onClick={() => updateStatus(order.id, order.status, '')} className="text-xs text-red-400 hover:text-red-600 ml-1">‚úï</button>}
                                                </div>
                                            ) : isAdmin ? (
                                                <input type="text" defaultValue=""
                                                    onBlur={(e) => e.target.value && updateStatus(order.id, order.status, e.target.value)}
                                                    onKeyDown={(e) => e.key === 'Enter' && e.target.value && updateStatus(order.id, order.status, e.target.value)}
                                                    placeholder="Ajouter une note..."
                                                    className="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent" />
                                            ) : (
                                                <span className="text-gray-300 text-xs">‚Äî</span>
                                            )}
                                        </td>
                                        <td className="px-4 py-3 text-center">
                                            <select value={order.status}
                                                onChange={(e) => isAdmin && updateStatus(order.id, e.target.value, order.commentaires)}
                                                disabled={!isAdmin}
                                                className={`px-3 py-1 border rounded text-sm ${!isAdmin ? 'bg-gray-100 cursor-not-allowed text-gray-400' : ''}`}>
                                                {Object.values(STATUTS).map(s => (<option key={s} value={s}>{s}</option>))}
                                            </select>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // OrdersTab
        function OrdersTab({ orders, updateStatus, isAdmin }) {
            const [selectedOrder, setSelectedOrder] = useState('');
            const [searchOrder, setSearchOrder] = useState('');
            const [selectedImage, setSelectedImage] = React.useState(null);
            
            const orderGroups = {};
            orders.forEach(order => {
                if (!orderGroups[order.reference]) {
                    orderGroups[order.reference] = [];
                }
                orderGroups[order.reference].push(order);
            });

            const orderNumbers = Object.keys(orderGroups).sort((a, b) => b - a);
            const filteredOrderNumbers = searchOrder 
                ? orderNumbers.filter(num => num.includes(searchOrder))
                : orderNumbers;

            return (
                <div className="space-y-6">
                    {/* Modal Image en grand */}
                    {selectedImage && (
                        <div 
                            className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"
                            onClick={() => setSelectedImage(null)}
                        >
                            <div className="max-w-4xl max-h-[90vh] relative">
                                <button
                                    onClick={() => setSelectedImage(null)}
                                    className="absolute -top-10 right-0 text-white text-2xl hover:text-gray-300"
                                >
                                    ‚úï Fermer
                                </button>
                                <img 
                                    src={selectedImage.url}
                                    alt={selectedImage.name}
                                    className="max-w-full max-h-[90vh] object-contain rounded shadow-2xl"
                                    onClick={(e) => e.stopPropagation()}
                                />
                                <p className="text-white text-center mt-4 text-lg">{selectedImage.name}</p>
                            </div>
                        </div>
                    )}
                    
                    <div className="bg-white rounded-lg shadow p-6">
                        <label className="block text-sm font-semibold mb-2">üîç Rechercher une commande</label>
                        <input
                            type="text"
                            placeholder="Tapez un num√©ro..."
                            value={searchOrder}
                            onChange={(e) => {
                                setSearchOrder(e.target.value);
                                const matches = orderNumbers.filter(num => num.includes(e.target.value));
                                if (matches.length === 1) setSelectedOrder(matches[0]);
                            }}
                            className="w-full px-4 py-2 border rounded-lg mb-4"
                        />
                        
                        <label className="block text-sm font-semibold mb-2">üìã Ou s√©lectionner</label>
                        <select
                            value={selectedOrder}
                            onChange={(e) => setSelectedOrder(e.target.value)}
                            className="w-full px-4 py-2 border rounded-lg"
                        >
                            <option value="">-- Choisir --</option>
                            {filteredOrderNumbers.map(num => (
                                <option key={num} value={num}>
                                    Commande #{num} ({orderGroups[num].length} articles)
                                </option>
                            ))}
                        </select>
                    </div>

                    {selectedOrder && (
                        <div className="bg-white rounded-lg shadow p-6">
                            <h3 className="text-xl font-bold mb-4">
                                Commande #{selectedOrder} - {orderGroups[selectedOrder].length} article(s)
                            </h3>
                            <div className="space-y-3">
                                {orderGroups[selectedOrder].map(order => (
                                    <div key={order.id} className="border rounded-lg p-4">
                                        <div className="flex justify-between items-start gap-4">
                                            {/* Photo */}
                                            {order.url_image && (
                                                <div className="flex-shrink-0">
                                                    <img 
                                                        src={order.url_image} 
                                                        alt={order.name}
                                                        className="w-20 h-20 object-cover rounded border cursor-pointer hover:opacity-80 transition"
                                                        onClick={() => setSelectedImage({ url: order.url_image, name: order.name })}
                                                        onError={(e) => e.target.style.display = 'none'}
                                                    />
                                                </div>
                                            )}
                                            
                                            <div className="flex-1">
                                                <h4 className="font-semibold text-lg">{order.name}</h4>
                                                
                                                {/* Infos client et transporteur */}
                                                <div className="mt-2 flex gap-4 text-sm text-gray-600">
                                                    {order.client && <span>üë§ {order.client}</span>}
                                                    {order.transporteur && <span>üöö {order.transporteur}</span>}
                                                    {order.quantity && <span>üì¶ Qt√©: {order.quantity}</span>}
                                                </div>
                                                
                                                {/* Commentaire */}
                                                <div className="mt-3">
                                                    {order.commentaires ? (
                                                        <p className="text-sm italic text-purple-700 bg-purple-50 border border-purple-200 rounded px-3 py-2">üí¨ {order.commentaires}</p>
                                                    ) : (
                                                        <input
                                                            type="text"
                                                            value=""
                                                            onChange={(e) => updateStatus(order.id, order.status, e.target.value)}
                                                            placeholder="üí¨ Ajouter une note..."
                                                            className="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-green-500 text-sm"
                                                        />
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {/* Statut */}
                                            <select
                                                value={order.status}
                                                onChange={(e) => updateStatus(order.id, e.target.value, order.commentaires)}
                                                className="px-3 py-2 border rounded text-sm flex-shrink-0"
                                            >
                                                {Object.values(STATUTS).map(s => (
                                                    <option key={s} value={s}>{s}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }


        // MultiOrdersTab - Clientes avec plusieurs commandes
        function MultiOrdersTab({ orders }) {
            const [selectedClient, setSelectedClient] = React.useState(null);

            // Grouper par client (nom + email)
            const clientMap = {};
            orders.forEach(o => {
                const key = (o.client || 'Inconnu') + '||' + (o.email || '');
                if (!clientMap[key]) {
                    clientMap[key] = {
                        nom: o.client || 'Inconnu',
                        email: o.email || '',
                        commandes: new Set(),
                        articles: []
                    };
                }
                clientMap[key].commandes.add(o.reference);
                clientMap[key].articles.push(o);
            });

            // Garder uniquement celles avec 2+ commandes
            const multiClients = Object.values(clientMap)
                .filter(c => c.commandes.size >= 2)
                .map(c => ({ ...c, commandes: [...c.commandes].sort((a,b) => b - a) }))
                .sort((a, b) => b.commandes.length - a.commandes.length);

            if (multiClients.length === 0) {
                return (
                    <div className="text-center py-16 text-gray-400">
                        <div className="text-5xl mb-4">üéâ</div>
                        <p className="text-lg font-semibold">Aucune cliente avec plusieurs commandes</p>
                        <p className="text-sm mt-2">Toutes les commandes sont uniques pour le moment</p>
                    </div>
                );
            }

            return (
                <div className="space-y-4">
                    {/* Modal d√©tail cliente */}
                    {selectedClient && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4" onClick={() => setSelectedClient(null)}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                                <div className="sticky top-0 bg-gradient-to-r from-purple-600 to-purple-700 text-white p-6 rounded-t-xl">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h3 className="text-xl font-bold">üë§ {selectedClient.nom}</h3>
                                            {selectedClient.email && <p className="text-purple-200 text-sm mt-1">‚úâÔ∏è {selectedClient.email}</p>}
                                            <p className="text-purple-200 text-sm mt-1">üì¶ {selectedClient.commandes.length} commandes ‚Äî {selectedClient.articles.length} articles</p>
                                        </div>
                                        <button onClick={() => setSelectedClient(null)} className="text-white text-2xl hover:text-purple-200">‚úï</button>
                                    </div>
                                </div>
                                <div className="p-6 space-y-4">
                                    {selectedClient.commandes.map(ref => {
                                        const items = selectedClient.articles.filter(a => a.reference === ref);
                                        const allDone = items.every(i => i.status === 'Termin√©');
                                        return (
                                            <div key={ref} className={`border rounded-lg overflow-hidden ${allDone ? 'border-green-300 bg-green-50' : 'border-gray-200'}`}>
                                                <div className="flex items-center justify-between px-4 py-3 bg-gray-50 border-b">
                                                    <span className="font-bold text-gray-800">Commande #{ref}</span>
                                                    {allDone ? <span className="text-xs bg-green-200 text-green-800 px-2 py-1 rounded-full">‚úÖ Termin√©e</span> : <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">‚è≥ En cours</span>}
                                                </div>
                                                {items.map((item, i) => (
                                                    <div key={i} className="flex items-center gap-3 px-4 py-3 border-b last:border-0">
                                                        {item.image && <img src={item.image} className="w-12 h-12 object-cover rounded" />}
                                                        <div className="flex-1 min-w-0">
                                                            <p className="text-sm font-medium text-gray-800 truncate">{item.name}</p>
                                                            {item.transporteur && <p className="text-xs text-gray-500">üöö {item.transporteur}</p>}
                                                        </div>
                                                        <span className={`text-xs px-2 py-1 rounded-full ${item.status === 'Termin√©' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>{item.status}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="flex items-center justify-between">
                        <h2 className="text-xl font-bold text-gray-800">üëØ Clientes multi-commandes</h2>
                        <span className="bg-purple-100 text-purple-700 text-sm font-semibold px-3 py-1 rounded-full">{multiClients.length} cliente(s)</span>
                    </div>

                    <p className="text-sm text-gray-500">Ces clientes ont pass√© plusieurs commandes ‚Äî pensez √† regrouper l'envoi !</p>

                    <div className="space-y-3">
                        {multiClients.map((client, i) => {
                            const totalArticles = client.articles.length;
                            const termines = client.articles.filter(a => a.status === 'Termin√©').length;
                            const allDone = termines === totalArticles;
                            const transporteurs = [...new Set(client.articles.map(a => a.transporteur).filter(Boolean))];
                            return (
                                <div key={i}
                                    className="bg-white rounded-xl shadow-sm border border-gray-200 p-4 cursor-pointer hover:shadow-md hover:border-purple-300 transition-all"
                                    onClick={() => setSelectedClient(client)}
                                >
                                    <div className="flex items-center justify-between gap-3">
                                        <div className="flex-1 min-w-0">
                                            <div className="flex items-center gap-2">
                                                <span className="font-semibold text-gray-800">{client.nom}</span>
                                                {allDone && <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">Tout termin√©</span>}
                                            </div>
                                            {client.email && <p className="text-xs text-gray-400 mt-0.5 truncate">‚úâÔ∏è {client.email}</p>}
                                            {transporteurs.length > 0 && <p className="text-xs text-gray-400 mt-0.5">üöö {transporteurs.join(', ')}</p>}
                                        </div>
                                        <div className="flex flex-col items-end gap-1 flex-shrink-0">
                                            <span className="bg-purple-100 text-purple-700 text-sm font-bold px-3 py-1 rounded-full">{client.commandes.length} commandes</span>
                                            <span className="text-xs text-gray-400">{termines}/{totalArticles} articles termin√©s</span>
                                        </div>
                                    </div>
                                    <div className="mt-3 flex flex-wrap gap-2">
                                        {client.commandes.map(ref => (
                                            <span key={ref} className="font-mono text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">#{ref}</span>
                                        ))}
                                    </div>
                                    <div className="mt-2 w-full bg-gray-100 rounded-full h-1.5">
                                        <div className="bg-green-500 h-1.5 rounded-full transition-all" style={{width: `${totalArticles > 0 ? (termines/totalArticles)*100 : 0}%`}}></div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // Page de connexion
        function LoginPage() {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async () => {
                if (!email || !password) { setError('Veuillez remplir tous les champs'); return; }
                setLoading(true); setError('');
                try {
                    await window.firebaseSignIn(email, password);
                } catch (e) {
                    setError('Email ou mot de passe incorrect');
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-green-50 to-emerald-100 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="text-6xl mb-4">üì¶</div>
                            <h1 className="text-2xl font-bold text-gray-800">Gestion Production</h1>
                            <p className="text-gray-500 text-sm mt-1">Sousou Fashion</p>
                        </div>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-1">Email</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && handleLogin()}
                                    placeholder="votre@email.com"
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-1">Mot de passe</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && handleLogin()}
                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                />
                            </div>
                            {error && <p className="text-red-500 text-sm bg-red-50 px-3 py-2 rounded-lg">{error}</p>}
                            <button
                                onClick={handleLogin}
                                disabled={loading}
                                className="w-full py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition disabled:opacity-50"
                            >
                                {loading ? 'Connexion...' : 'Se connecter'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Render
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
